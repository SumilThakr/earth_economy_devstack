<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.287">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>earth_economy_devstack</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="earth_economy_devstack_files/libs/clipboard/clipboard.min.js"></script>
<script src="earth_economy_devstack_files/libs/quarto-html/quarto.js"></script>
<script src="earth_economy_devstack_files/libs/quarto-html/popper.min.js"></script>
<script src="earth_economy_devstack_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="earth_economy_devstack_files/libs/quarto-html/anchor.min.js"></script>
<link href="earth_economy_devstack_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="earth_economy_devstack_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="earth_economy_devstack_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="earth_economy_devstack_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="earth_economy_devstack_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Earth-Economy Devstack</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Placeholder file that will collect the cross-repo organizational standards common to our software stack</p>
<section id="id-index-label-name-description" class="level2">
<h2 class="anchored" data-anchor-id="id-index-label-name-description">Id, index, label, name, description</h2>
<p>In programming, <code>id</code> and <code>index</code> are two different concepts that are used in different contexts.</p>
<p><code>id</code> refers to the unique identifier of an object. In this specification, it is an integer that is sorted by the ONE in the many-to-one correspondence, sorted alphabetically at generation time (though not necessarily to remain sorted given downstream correspondences).</p>
<p><code>index</code> refers to the position of an element in a sequence (e.g.&nbsp;a list or a string). In the context of a correspondence file, this is the position of the row within the sorted spreadsheet, but is not assumed to be stable and shouldn’t generally be used.</p>
<p><code>labelheader</code> refers to an (exactly) 4 character string that is lowercase-alphanumeric with no special symbols besides underscore. Useful for the Header label in har files. Technically is case insensitive but we assume lowercase.</p>
<p><code>labelshort</code> refers to an 8-character or less string that is lowercase-alphanumeric with no special symbols besides underscore. Useful for .har files.</p>
<p><code>label</code> refers to a string that is lowercase-alphanumeric with no special symbols besides underscore</p>
<p><code>name</code> refers to a string of any ascii characters with python-style escaping of special characters: <code>'She\'s a star!'</code> . It’s assumed to be short enough to view as a column header or plot label</p>
<p><code>Description</code> refers to a <code>name</code> of any length with detailed description, possibly even formatted MD text.</p>
<p>If there is a domain, described below, id, index, etc all should prepended with it to be eg <code>gadm_id</code>.</p>
<section id="id-index-etc.-in-the-context-of-vector-data" class="level3">
<h3 class="anchored" data-anchor-id="id-index-etc.-in-the-context-of-vector-data">Id, Index etc. in the context of vector data</h3>
<p>Note that geopandas assumes the vector data are indexed with an FID. This is the order in which the geometries are added to the file and can get wonky when dealing with legacy file types (like ESRI Shapefiles). Additionally, when you write a GPKG to a CSV, it will not include the fid, so you might lose data. To fix this, EE spec requires that any GPKG when saved as a CSV have a new column, <code>id</code> added as the first col, which is generated starting at 1 and incrementing up by 1 after having sorted the data on the simplest non-fid label (e.g., iso3_label). See <code>gtap_invest_generate_base_data.py</code>.</p>
</section>
</section>
<section id="labels-files" class="level2">
<h2 class="anchored" data-anchor-id="labels-files">Labels files</h2>
<p>Based on how the GTAP database is structured, EE spec defines several file types of files to systemetize how dimensions/sets are defined (and then used in e.g.&nbsp;figure plotting). A single dimension is first defined by a labels file. The labels file has at least 3 columns of <code>domain_id</code>, <code>domain_label</code>, <code>domain_name</code> and <em>optionally</em> a <code>domain_description</code>. If present, a column needs to be fully filled (no missing values). Label files are used in other contexts to, e.g., go from id to name for labeling an axis on a plot, as well as building the correspondence files below.</p>
</section>
<section id="correspondences" class="level2">
<h2 class="anchored" data-anchor-id="correspondences">Correspondences</h2>
<p>Model linkages often require mapping many-to-one relationship in a consistent way. Correspondence files define this via a src-to-dst (source and destination). They are named according to a relatively complex pattern. Specifically, using the file path <code>gadm_r263_gtapv7_r251_r160_r50_correspondence</code>, we have a domain label <code>gadm</code> followed by</p>
<ul>
<li>a <code>src</code> dimension-size pair <code>r263</code> (where r is a label, short for region in this case, and 263 is the number of unique entries in that dimension). To be a correspondence,there needs to be at least one other <code>dst</code> dimension-size pair, where in this case there are 3 additional dimension-size pairs (<code>r251</code>, <code>r160</code>, and <code>r50</code>). However, the later three pairs are from a different domain, namely that of <code>gtapv7</code>. Each pair is identified with the domain most identified most closely prior.</li>
<li>The <code>dst</code> dimension-size pairs are sorted in order of decreasing size. The <code>dst</code> dimension-size pairs are then followed by the word <code>correspondence</code>. This example creates a correspondence file that maps from the GADM 263 regions to the GTAPv7 251 regions, which are then mapped to the GTAPv7 160 regions, which are then mapped to the GTAPv7 50 regions.</li>
</ul>
<p>An example of a 2-type correspondence is below. However, in this file, <code>src</code> and <code>dst</code> would have to be replaced with the specific domain names used.</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>src_id</th>
<th>dst_id</th>
<th>src_label</th>
<th>dst_label</th>
<th>src_description</th>
<th>dst_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>aus</td>
<td>oceania</td>
<td>Australia</td>
<td>Oceania (including NZ and AUS)</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>nzl</td>
<td>oceania</td>
<td>New Zealand</td>
<td>Oceania (including NZ and AUS)</td>
</tr>
</tbody>
</table>
<p>Here are the specific labels and corespondence files generated for gtapv7-aez-rd:</p>
<p><img src="images/paste-22.png" class="quarto-discovered-preview-image img-fluid"></p>
<p>If defined exactly right, 2 dimensional correspondence files will work with Hazelbean via</p>
<p><code>seals_utils.set_derived_attributes(p)</code></p>
<p>and</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>p.lulc_correspondence_dict <span class="op">=</span> hb.utils.get_reclassification_dict_from_df(p.lulc_correspondence_path, <span class="st">'src_id'</span>, <span class="st">'dst_id'</span>, <span class="st">'src_label'</span>, <span class="st">'dst_label'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which will return a very useful dictionary for various reclassification tasks:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>return_dict <span class="op">=</span> {}</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_to_src_reclassification_dict'</span>] <span class="op">=</span> dst_to_src_reclassification_dict  <span class="co"># Dict of one-to-many keys to lists of what each dst_key should be mapped to from each src_key. Useful when aggrigating multiple layers to a aggregated dest type</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'src_to_dst_reclassification_dict'</span>] <span class="op">=</span> src_to_dst_reclassification_dict <span class="co"># Useful when going to a specific value.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_to_src_labels_dict'</span>] <span class="op">=</span> dst_to_src_labels_dict <span class="co"># Dictionary of lists of labels that map to each dst label</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'src_ids'</span>] <span class="op">=</span> remove_duplicates_in_order(src_ids) <span class="co"># Unique set of src_ids</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_ids'</span>] <span class="op">=</span> remove_duplicates_in_order(dst_ids) <span class="co"># Unique set of dst_ids</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'src_labels'</span>] <span class="op">=</span> remove_duplicates_in_order(src_labels) <span class="co"># Unique set of src_labels</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_labels'</span>] <span class="op">=</span> remove_duplicates_in_order(dst_labels) <span class="co"># Unique set of dst_labels</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'src_ids_to_labels'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(return_dict[<span class="st">'src_ids'</span>], return_dict[<span class="st">'src_labels'</span>])} <span class="co"># one-to-one dictionary of src ids to labels</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_ids_to_labels'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(return_dict[<span class="st">'dst_ids'</span>], return_dict[<span class="st">'dst_labels'</span>])} <span class="co"># one-to-one dictionary of dst ids to labels</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'src_labels_to_ids'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(return_dict[<span class="st">'src_labels'</span>], return_dict[<span class="st">'src_ids'</span>])} <span class="co"># one-to-one dictionary of src labels to ids</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>return_dict[<span class="st">'dst_labels_to_ids'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(return_dict[<span class="st">'dst_labels'</span>], return_dict[<span class="st">'dst_ids'</span>])} <span class="co"># one-to-one dictionary of dst labels to ids</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Among other possibilities, this could be used for reclassifying LULC geotiffs via</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rules <span class="op">=</span> p.lulc_correspondence_dict[<span class="st">'src_to_dst_reclassification_dict'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>hb.reclassify_raster_hb(raster_path, rules, output_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="correspondences-with-geometries" class="level3">
<h3 class="anchored" data-anchor-id="correspondences-with-geometries">Correspondences with geometries</h3>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The rules for naming correspondences are a little different when adding geometry to the data. Because</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only 1 geometry can be assigned per file, and becasue membership of aggregated regions and their</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># members can get confusing, each correspondence file keeps all the labels but then is also saved along</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with a geometry file that drops the other labels (and the word correspondence in the filename).</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    p.ee_r264_correspondence_vector_path <span class="op">=</span> p.get_path(os.path.join(<span class="st">'gtap_invest'</span>, <span class="st">'region_boundaries'</span>, <span class="st">'ee_r264_correspondence.gpkg'</span>))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    p.ee_r264_vector_path <span class="op">=</span> p.get_path(os.path.join(<span class="st">'gtap_invest'</span>, <span class="st">'region_boundaries'</span>, <span class="st">'ee_r264.gpkg'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="naming-conventions" class="level2">
<h2 class="anchored" data-anchor-id="naming-conventions">Naming Conventions</h2>
<p>The names of project-level variables are carefully defined. For example, in <code>gtapv7_r251_r160_correspondence_input_path</code>, the <code>input</code> when put right before the word path implies it is a raw asset we obtained from an external source but haven’t processed it yet. This means that it can be a non-compliant <code>XLSX</code> file. Aslo, path implies that it is a string type that points to a location in a storage device. In this name, we see two other structures. First, the gtapv7 label indicates the “domain” of the correspondence defined in all of the following dimensions (until another domain label). Above, this means that it is the 251 regions, as defined by the gtapv7 domain, mapped to the 160 regions in the same domain.</p>
<p>You can have multiple mappings in a single correspondence file. For example, <code>gtapv7_r251_s65_r50_s26_correspondence_input_path</code>, we are mapping r251 to r50 and s (sectors) 65 to s26, all in the gtapv7 domain.</p>
<p>Appart from correspondence files, we also have <strong>labels</strong> files, such as <code>gtapv7_r251_labels_path</code>. Labels files are for a single set/variable/dimension but map together the synonymous categorizers. Specifically, it must have an <code>id</code>, <code>label</code>, and <code>name</code>, all filled out for every entry. It can optionally have others like description.</p>
<p>In the filename <code>gtapv7_r251_labels_path</code> we extract from the input_path and write a EE-compliant labels table for the gtapv7 r251 set. In the filename <code>gtap11_gtapaez11_region_correspondence_path</code>, we use these regions and then connect it to the gtapaez11 labels. We can infer also that it is from a mapping labeled gtap11 to gtapaez11 and that the variable in question is the regions while the word correspondence then indicates this is a many-to-one mapping file.</p>
<p>Note that the file path says “regions” while the column label in the CSV says “region”.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    p.gtap11_region_correspondence_input_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'GTAP-ctry2reg.xlsx'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    p.gtap11_region_names_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'gtap11_region_names.csv'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    p.gtap11_gtapaez11_region_correspondence_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'gtap11_gtapaez11_region_correspondance.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="task-format" class="level2">
<h2 class="anchored" data-anchor-id="task-format">Task Format</h2>
<p>Project flow requires a consistent format for tasks. The following is an example of a task that creates a correspondence file from gtap11 regions to gtapaez11 regions. The task itself defined as a function that takes a <code>p</code> object as an argument. This <code>p</code> object is a <code>ProjectFlow</code> object that contains all the project-level variables, manages folders and files, and manages tasks and parallelization. <code>p</code> also includes documentation, which will be written directly into the task directory.</p>
<p>Also note that any project-level attribute defined in between the function start and the <code>if p.run_this:</code> component are the “project level variables” that are fair-game for use in other tasks. These paths are critical for high performance because they enable quick-skipping of completed tasks and determiniation of which parts of the task tree need rerunning.</p>
<p><strong>Tasks should be named as a noun</strong> (this breaks Python pep8 style) referencing what will be stored in the tasks output dir. This might feel awkward at first, but it means that the resultant file structure is easier to interpret by a non-EE outsider.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gtap_aez_seals_correspondences(p):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    p.current_task_documentation <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">    Create correspondence CSVs from ISO3 countries to GTAPv11 160</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">    regions, and then to gtapaezv11 50ish regions, also put the classification</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">    for seals simplification and luh.  </span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    p.gtap11_region_correspondence_input_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'GTAP-ctry2reg.xlsx'</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    p.gtap11_region_names_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'gtap11_region_names.csv'</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    p.gtap11_gtapaez11_region_correspondence_path <span class="op">=</span> os.path.join(p.base_data_dir, <span class="st">'gtappy'</span>, <span class="st">'aggregation_mappings'</span>, <span class="st">'gtap11_gtapaez11_region_correspondance.csv'</span>)    </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p.run_this:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"logic here"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="automatic-directory-organization-via-tasks" class="level2">
<h2 class="anchored" data-anchor-id="automatic-directory-organization-via-tasks">Automatic Directory Organization via Tasks</h2>
<p>Hazelbean automatically defines directory organization as a function of the task tree. When the ProjectFlow object is created, it takes a directory as its only required input. This directory defines the root of the project. The other directory that needs to be referenced is the base_data_dir. When you initialize the p object, it notes this:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Created ProjectFlow <span class="bu">object</span> at C:\Users\jajohns\Files\gtap_invest\projects\cwon     <span class="im">from</span> script C:\Users\jajohns\Files\gtap_invest\gtap_invest_dev\gtap_invest\run_cwon.py     <span class="cf">with</span> base_data <span class="bu">set</span> at C:\Users\jajohns\Files<span class="op">/</span>base_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the run file, the following line generates the task tree:</p>
<p><code>gtap_invest_initialize_project.build_extract_and_run_aez_seals_task_tree(p)</code></p>
<p>Which points to a builder function in the initialize file, looking something like this:</p>
<p><img src="images/paste-28.png" class="img-fluid"></p>
<p>This would generate the following task tree:</p>
<p><img src="images/paste-27.png" class="img-fluid"></p>
<p>Two notations are especially useful within this task tree.</p>
<ol type="1">
<li>Within the function that defines a task, <code>p.cur_dir</code> points to the directory of that task. So for instance, the last task defined in the image above, in its code, you could reference <code>p.cur_dir</code>, and it would point to <code>&lt;project_root&gt;/econ_vizualization/econ_lcovercom</code></li>
<li>Outside of a given function’s code, you can still refer to paths that were defined from within the functions code, but now (because you are outside the function) it is given a new reference. Using the example above, you could reference the same directory with <code>p.econ_lcovercom_dir</code> where the p attribute is named exactly as <code>\&lt;function_name\&gt;\_dir</code></li>
</ol>
<p>All of this setup enable another useful feature: automatic management of file generation, storage and downloading. This is done via the hazelbean function:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>useful_path <span class="op">=</span> hb.get_path(relative_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function will iteratively search multiple locations and return the most “useful” one. By default, the <code>relative_path</code> variable will first joined with the <code>p.cur_dir</code>. If the file exists, it returns it. If not, it checks the next location, which is p.input_dir, and then p.base_data_dir. If it doesn’t find it anywhere, it will attempt to download it from google cloud (NYI) and save it in the <code>p.cur_dir</code>. If it is not available to download on google cloud, then it treats the path as something we will be generating within the task, and thus, <code>get_path</code> returns the first option above, namely joining the relative_path with <code>p.cur_dir</code>.</p>
<p>One exception to this is if you are calling <code>get_path</code> outside of a task/task_tree. One common example is in the run file before you build the task tree. In this case, the default_dirs will not make sense, and so you need to specify it manually as here:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>p.countries_iso3_path <span class="op">=</span> p.get_path(os.path.join(<span class="st">'cartographic'</span>, <span class="st">'gadm'</span>, <span class="st">'gadm_adm0_10sec.gpkg'</span>), possible_dirs<span class="op">=</span>[p.input_dir, p.base_data_dir])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="validation-of-files" class="level2">
<h2 class="anchored" data-anchor-id="validation-of-files">Validation of files</h2>
<p>ProjectFlow is designed to calculate very fast while simultaneously validating that everything is approximately correct. It does this by checking for the existence of files (often combined with <code>hb.get_path()</code>). For example</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>p.gadm_r263_gtapv7_r251_r160_r50_correspondence_vector_path <span class="op">=</span> p.get_path(os.path.join(<span class="st">'gtap_invest'</span>, <span class="st">'region_boundaries'</span>, <span class="st">'gadm_r263_gtapv7_r251_r160_r50_regions.gpkg'</span>))     </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> hb.path_exists(p.gadm_r263_gtapv7_r251_r160_r50_correspondence_vector_path):         </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    hb.log(<span class="st">'Creating '</span> <span class="op">+</span> p.gadm_r263_gtapv7_r251_r160_r50_correspondence_vector_path)         </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"computationally expensive thing here."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ProjectFlow very carefully defines whether or not you should run something based on the existence of specific paths. Usually this is just checking for each written path and only executing the code if it’s missing, but in some cases where lots of files are created, it’s possible to take the shortcut of just checking for the existence of the last-created path.</p>
<section id="eliminating-redundant-calculation-across-projects" class="level3">
<h3 class="anchored" data-anchor-id="eliminating-redundant-calculation-across-projects">Eliminating redundant calculation across projects</h3>
<p>If you have a time consuming task that, or example, writes to</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>big_file_path <span class="op">=</span> hb.get_path(<span class="st">'lulc'</span>, <span class="st">'esa'</span>, <span class="st">'seals7'</span>, <span class="st">'convolutions'</span>, <span class="st">'2017'</span>, <span class="st">'convolution_esa_seals7_2017_cropland_gaussian_5.tif'</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this example, suppose you needed to create this file via your <code>create_convolutions()</code> task or something. When you first do this, it obviously won’t exist yet, so <code>get_path()</code> will join that relative path in the <code>p.cur_dir</code> location. If you run the ProjectFlow again, it will see it’s there and then instantly skip recalcualting it.</p>
</section>
</section>
<section id="ee-file-organization" class="level1">
<h1>EE File organization</h1>
<p>If you have the same directory structure by putting the 5 folders: <code>gtap_invest</code>, <code>gtappy</code>, <code>hazelbean</code>, <code>seals</code>,<code>global_invest</code>, and the devstack folder <code>earth_economy_devstack</code> folder under your customized <code>Files</code> folder, for example like this:</p>
<p><code>C:\Users\jajohns\Files\</code></p>
<p>Then everytime, you can only change the path <code>C:\Users\jajohns\</code> before <code>Files</code> without changing the path in the code.</p>
<p><img src="images/paste-23.png" class="img-fluid"></p>
<p><img src="images/paste-24.png" class="img-fluid"></p>
<p>In addition to the 5 repos plus the EE repo, there is a managed base data set stored in the same location</p>
<p><img src="images/paste-25.png" class="img-fluid"></p>
<p><img src="images/paste-26.png" class="img-fluid"></p>
<hr>
<p><strong>NOTE:</strong> If you are developer of one of the five tools, then you should have a <code>_dev</code> folder inside of the repo folder. For example, if you are a developer of <code>gtappy</code>, then you should have a <code>gtappy_dev</code> folder inside of the <code>gtappy</code> folder. The <code>launch.json</code> file in the EE devstack folder will helps you to open all the corresponding file for the workspace automatically.</p>
<p><img src="images/paste-29.png" class="img-fluid"></p>
<hr>
<section id="gtappy-details" class="level2">
<h2 class="anchored" data-anchor-id="gtappy-details">GTAPpy details</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<section id="cython-installation" class="level4">
<h4 class="anchored" data-anchor-id="cython-installation">Cython Installation</h4>
<p><img src="images/paste-3.png" class="img-fluid"></p>
<p><img src="images/paste-4.png" class="img-fluid"></p>
<p><img src="images/paste-5.png" class="img-fluid"></p>
<p><img src="images/paste-6.png" class="img-fluid"></p>
<p><img src="images/paste-8.png" class="img-fluid"></p>
<p><img src="images/paste-9.png" class="img-fluid"></p>
<p><img src="images/paste-10.png" class="img-fluid"></p>
</section>
<section id="run-gtap-installation-simple-for-class" class="level4">
<h4 class="anchored" data-anchor-id="run-gtap-installation-simple-for-class">Run-GTAP installation simple for class</h4>
<p><strong>Step 1:</strong></p>
<ul>
<li><p>Install RunGTAP at <a href="https://www.gtap.agecon.purdue.edu/products/rungtap/default.asp" class="uri">https://www.gtap.agecon.purdue.edu/products/rungtap/default.asp</a></p></li>
<li><p>At <a href="https://www.copsmodels.com/gpeidl.htm" class="uri">https://www.copsmodels.com/gpeidl.htm</a> download: <a href="https://www.copsmodels.com/ftp/ei12dl/gpei-12.1.004-install.exe" class="uri">https://www.copsmodels.com/ftp/ei12dl/gpei-12.1.004-install.exe</a>&nbsp;</p>
<ul>
<li>OR FOR VERSION 12: <a href="https://www.copsmodels.com/ftp/ei12dl/gpei-12.0.004-install.exe" class="uri">https://www.copsmodels.com/ftp/ei12dl/gpei-12.0.004-install.exe</a></li>
</ul></li>
<li><p>Install to default location</p></li>
</ul>
<p><img src="images/paste-13.png" class="img-fluid"></p>
<p>Proceed without selecting a license (to start the 6 month trial).</p>
<p><strong>Step 2:</strong> Install GTAPAgg2: <a href="https://www.gtap.agecon.purdue.edu/private/secured.asp?Sec_ID=1055" class="uri">https://www.gtap.agecon.purdue.edu/private/secured.asp?Sec_ID=1055</a></p>
<p>TO PROCEED, YOU NEED TO HAVE A ACCESS TO THE GTAP DATABASE. OR YOU CAN ACCESS IT THROUGH <code>ee_internal</code> DATABASE.</p>
<p><strong>Getting the v7 code</strong></p>
<ul>
<li><p>Extract from RunGTAP (lol)</p></li>
<li><p>Under Version, Change, set to <code>NCORS3x3</code></p></li>
<li><p>Under Version, New, use wizard using same aggregation and simply copying.</p></li>
</ul>
<p><img src="images/paste-19.png" class="img-fluid"></p>
<ul>
<li><p>This will create a new folder in c:/runGTAP375 named v7all.</p></li>
<li><p>Now we will replace the data files in v7all with the fully disaggregated database (in the v7 dir) we created above.</p></li>
<li><p>Notice also in the v7dir we have shock files, e.g.&nbsp;<code>tinc.shk</code>.&nbsp;</p>
<ul>
<li><p>By default, these will be inherited from the old 3x3 version.</p></li>
<li><p>Under Tools, Run Test Simulation. This will rewrite new shk files to match aggregation.</p>
<ul>
<li>ALSO NOTE, this is the full run that tested it all worked.</li>
</ul></li>
<li><p>To check that it worked, go to results, macros.&nbsp;</p></li>
<li><p>Or, could open results in <code>ViewSOL</code>. Use View -&gt; Results Using ViewSOL</p>
<ul>
<li><p><code>ViewSOL</code> has the full results, whereas RunGTAP only has a subset by the limited mapping specific to <code>RunGTAP</code>. <code>ViewSOL</code> loads the whole <code>sl4</code> file.</p></li>
<li><p>Here you could go to e.g.&nbsp;<code>pgdp</code> to see that prices all went up by 10%, which is the default shock i guess?</p></li>
</ul></li>
<li><p>OR, from <code>ViewSOL</code> File, can open in <code>ViewHAR</code>, which gives even more power, such as dimensional sorting.</p></li>
</ul></li>
<li><p>Now we can run a non-trivial shock. So for global ag productivity shock, let’s increase productivity.</p>
<ul>
<li><p>In <code>RunGTAP</code>, go to view <code>RunCMFSTART</code> file. Here we will define a new set for the new experiments. (<code>CMFSTART</code> files sets settings for runtime, but also which are the files that should be called, along with sets for the closure).</p>
<ul>
<li><p>To do this, go to <code>RunGTAP-\&gt;View-\&gt;Sets</code>, enable advanced editing, <code>Sets-\&gt;View Set Library</code></p>
<ul>
<li><p>Here click on <code>COMM</code>, copy elements in <code>tablo</code> format. This will get the set definition in <code>tablo</code> format of ALL the commodities. From this you can pare down to which you want to shock,</p></li>
<li><p>For the moment, we will create two sets, one for ag commodities (<code>ag_comm</code>), and one for a smaller subset of agg commodities (<code>ag_comm_sm</code>).</p></li>
<li><p>And will also define what is the complementary set (<code>xag_comm_sm</code>) of <code>ag_comm_sm</code>.</p></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><img src="images/paste-20.png" class="img-fluid"></p>
<p>Now that the sets are defined, can use them in defining the SHOCKS</p>
<p><img src="images/paste-21.png" class="img-fluid"></p>
<ul>
<li><p>Set the solution method to <code>gragg 2-4-6</code></p></li>
<li><p>Save experiment.</p></li>
<li><p>Then Solve!</p>
<ul>
<li>Comment from TOM: If Gragg doesn’t work, use Euler with many steps 20-50</li>
</ul></li>
</ul>
<p><strong>From second call with Erwin on cmd and rungtap versions</strong></p>
<hr>
<ul>
<li><p>Note that now we have a tax, we do it on both domestic and imported, then write a new equation that makes them sum up:&nbsp;</p>
<ul>
<li>E_tpm (all, c, COMM)(all, r, REG) tmp(c, r) = tpmall + tpreg + tpall</li>
</ul></li>
<li><p>Note that we now set the rate% of beef tax to increase 50%. Before we were increasing it by a 50% POWER OF THE tariff.</p></li>
<li><p>First run testsim.bat.</p></li>
<li><p>Then run the simulations.</p></li>
<li><p>In rungtapv7.bat then,&nbsp;</p></li>
<li><p>Simresults.bat last. Takes the sl4 files and converts it into a har file (<code>.sol</code>), and then combines them into 1 file, then splits to CSV.</p></li>
<li><p><code>RMAC</code> is full dimension, <code>RMCA</code> is aggregated by chosen aggregation simplification.</p>
<ul>
<li><code>AggMap.har</code> defines the aggregation.</li>
</ul></li>
<li><p>When <code>Allres.CMF</code> is run, which actually does the aggregation.</p>
<ul>
<li><code>Allres.cmf</code> calls to <code>allres.tab</code>, which cleans the results. This would need to have new scenarios added to the top</li>
</ul></li>
<li><p><code>Allres.EXP</code> also needs to be updated, along with the scenario <code>EXP</code> files to have thecorrect exogenous variables, such as <code>tpdall</code></p></li>
</ul>
<hr>
<p><strong>alternatively just specify they use <code>hb.get_path()</code> to the private database.</strong></p>
</section>
</section>
</section>
<section id="release-notes" class="level2">
<h2 class="anchored" data-anchor-id="release-notes">Release notes</h2>
<section id="v2023-12-18" class="level3">
<h3 class="anchored" data-anchor-id="v2023-12-18">v2023-12-18</h3>
<p>We need to clarify how we go from a erwin-style mapping xlsx to EE spec. Below is what it looks like as downloaded from Erwin.</p>
<p>GTAP-ctry2reg [source from erwin converted to EE spec].xlsx</p>
<p><img src="images/paste-1.png" class="img-fluid"></p>
<p>Manually renamed to gtapv7_r251_r160_correspondence.xlsx (must be excel cause multi workbook). Also need to put the legend information somewhere else in a well-thought-out place (not attached to regions correspondnce)</p>
<p>Note that eg No.&nbsp;is used twice where the first is r160 and the second is r251. New input mapping should clarify</p>
<p>Similar for sectors</p>
<p><img src="images/paste-2.png" class="img-fluid"></p>
<p>First note, the word “sector” is specific to the case when you aren’t specifying if you’re talking about COMM (commodities) or ACTS (activities) because I’m not quite sure of the differentiation at this point.</p>
<p>Notes from Erwin on GTAPPY</p>
</section>
<section id="v2023-12-15" class="level3">
<h3 class="anchored" data-anchor-id="v2023-12-15">v2023-12-15</h3>
<p>Issues resolved:</p>
<ol type="1">
<li><p>In the release’s Data folder, the aggregation label gtapaez11-50 should be renamed v11-s26-r50, correct?</p></li>
<li><p>Also note that I have decided to have the most recent release always have NO timestamp whereas dated versions of same-named models/aggregations should add on the timestamp of when they were first released</p></li>
<li><p>Propose changing the names of the cmf files from cwon_bau.cmf to gtapv7-aez-rd_bau.cmf and cwon_bau-es.cmf to gtapv7-aez-rd_bau-es (note difference between hyphens (which imply same-variable) and underscores, which are used to split into list.)</p></li>
<li><p>Propose not using set PROJ=cwon in the CMF as that is defined by the projectflow object.</p></li>
<li><p>propose changing SIMRUN to just ‘experiment_name’ ie “bau” rather than “projname” + “bau”</p></li>
<li><p>Reorganize this so that data is in the base_data_dir and the output is separated from the code release” set MODd=..set CMFd=.</p></li>
</ol>
<p>set SOLd=..set DATd=..%AGG%</p>
<p>THESE TWO STAY OUTSIDE THE RELEASE</p>
<ol start="7" type="1">
<li><p>This basic idea now is that there is a release that someone downloads, and they could run it either by calling the bat file or by calling the python run script. This means i’m trying to make the two different file types as similar as possible. However, note that the bat file is only going to be able to replicate a rd run without ES, so technically the python script can contain a bat file but not vice versa.</p></li>
<li><p>Renamce command line cmf options as tehy’re referenced in the cmf file: # CMF: experiment_label # Rename BUT I understand this one might not be changeable because it appears to be defined by the filename of the CMF? # p1: gtap_base_data_dir # p2: starting_data_file_path # Rename points to the correct starting har # p3: output_dir # Rename # p4: starting_year # Rename # p5: ending_year # Rename</p></li>
<li><p>Simple question: Is there any way to read the raw GEMPACK output to get a sense of how close to complete you are? I would like to make an approximate progress bar.</p></li>
</ol>
<ul>
<li><p>When you say “automatic accuracy”, you can.</p>
<p>+++&gt; Beginning subinterval number 4.</p>
<p>—&gt; Beginning pass number 1 of 2-pass calculation, subinterval 4.</p>
<p>Beginning pass number 6 of 6-pass calculation, subinterval 6</p></li>
</ul>
<ol start="10" type="1">
<li>Would it be possible to not put a Y in front of years like Y2018? This can mess up string-&gt;int conversions.</li>
</ol>
<p>keep Y, gempack can’t have non-numeric characters at the start of a var</p>
<ol start="11" type="1">
<li>There is no bau-SUM_Y2050 (but ther is for VOL and WEL). Is this intentional?</li>
</ol>
<p>NO! SUM describes the starting database.</p>
<p>Welfare not possibly in RD because no discount rate eg</p>
<ol start="12" type="1">
<li>Question: Is EVERYTHING stored in the SL4? I.e., are the other files redundant?</li>
</ol>
<p>No, apparently things like the converting the sl4 to volume terms is not stored in the sl4, so that needs to come in on sltht or in ViewSOL</p>
</section>
<section id="v2023-11-01" class="level3">
<h3 class="anchored" data-anchor-id="v2023-11-01">v2023-11-01</h3>
<section id="shocks-implemented" class="level4">
<h4 class="anchored" data-anchor-id="shocks-implemented">Shocks implemented</h4>
<ol type="1">
<li>Different population file replacements</li>
<li>GDP change</li>
<li>Yield changes?</li>
</ol>
</section>
<section id="example-run-file" class="level4">
<h4 class="anchored" data-anchor-id="example-run-file">Example run file</h4>
<p><img src="images/2022-12-12-10-31-05.png" class="img-fluid"></p>
<p>At the top we create the project flow object. We will add tasks to this.</p>
</section>
<section id="example-executable-call" class="level4">
<h4 class="anchored" data-anchor-id="example-executable-call">Example executable call</h4>
<p><img src="images/2022-12-12-10-33-44.png" class="img-fluid"></p>
</section>
<section id="harder-part-to-do-is-figuring-out-how-to-have-the-shocks-work" class="level4">
<h4 class="anchored" data-anchor-id="harder-part-to-do-is-figuring-out-how-to-have-the-shocks-work">Harder part to do is figuring out how to have the shocks work</h4>
<p>Need to create xSets, xSubsets, Shock. Could use READFROMFILE command in tablo cmf.</p>
</section>
<section id="what-are-the-different-kinds-of-shocks" class="level4">
<h4 class="anchored" data-anchor-id="what-are-the-different-kinds-of-shocks">What are the different kinds of shocks</h4>
<p><strong>Uniform</strong> Shockaoall(AGCOM_SM, reg) = uniform 20;</p>
<p>Another more</p>
<p>aoall(ACTS, REG) = file select from file pointing to a list of all regions. 0 is no shock.</p>
<p>Everything in the exogenous list can be shocks.</p>
<p>Also can SWAP an initially endogenous with exogenous.</p>
<p>E.g. swap aoreg with GDP</p>
<p>What about changing an elasticity?</p>
<p>those are in gtapparm, so write a new .prm (this is not a shock but is just replacing an input.)</p>
<p>Notice that there are shocks vs data updates.</p>
<p>The elasticities are being calibrated??? if you change the basedata to basedata2, then a different default2.prm, with no shock, the model will replicate the initial database.</p>
<p>If it’s a supply response elasticity (as in PNAS) that WILL affect it (unlike above).</p>
<p>needs to be percentage change over default POP. In base data. Read this in and process it against Eric’s file.</p>
<p>Shock pop(REG) = SELECT FROM FILE filename header 4ltr header. Swap QGDP aoreg shock aoall (agcom_sm, reg) = select from yield file.</p>
</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>